# 更新日志 (CHANGELOG)

本文件记录项目的所有版本更新。

---

## [2.5.1] - 2025-12-22

### 修复
- **修复 Mac 系统无法自动打开文件夹**：采集完成后，Mac 系统现在也能自动打开保存的文件夹
  - 新增 `openFolder()` 跨平台函数，根据操作系统自动选择正确的命令
  - Windows: `explorer`、macOS: `open`、Linux: `xdg-open`

---

## [2.5.0] - 2025-12-16

### 新增
- **并发下载**：支持 5 张图片同时下载，大幅提升采集速度
- **实时下载进度**：弹窗显示"正在下载 X/Y..."，让用户了解当前进度
- **Lazy Loading 图片支持**：自动识别 `data-src`、`data-lazy-src`、`data-original`、`data-lazy`、`data-url`、`data-image`、`data-srcset` 等懒加载属性
- **CSS 背景图支持**：采集通过 `background-image` 显示的图片，以及 `data-background`、`data-bg`、`data-background-image` 等属性
- **`<picture>` 标签支持**：采集 `<source>` 元素中的 srcset 图片
- **`getUpdateProgressScript()` 函数**：overlay.ts 新增进度更新脚本

### 优化
- **版本号统一管理**：所有版本号从 package.json 动态读取，不再硬编码
- **overlay.ts 重构**：所有函数改为返回字符串形式，支持动态传入版本号
- **collector.ts 重构**：提取 `prepareDownloadTasks()` 函数，分离任务准备和下载逻辑

### 修复
- **版本号不一致问题**：index.ts 和 overlay.ts 版本号现在自动与 package.json 同步

---

## [2.4.0] - 2025-12-15

### 新增
- **缩略图预览列**：采集完成弹窗的明细表格中新增"缩略图"列，位于类型和文件名之间，尺寸 46x46 像素，上下居中显示

### 优化
- **统一表头和内容列宽度**：明细表格的标题行和数据行宽度完全一致，标题文案水平居中
- **调整图片尺寸列宽度**：图片尺寸列从 90px 调整为 70px

---

## [2.3.0] - 2025-12-15

### 移除
- **移除登录等待功能**：不再弹窗询问用户"是否需要登录"，打开网页后直接开始采集
- **移除底部倒计时条**：不再显示登录等待期间的倒计时进度条
- 删除 `overlay.ts` 中的 `getLoginPromptInitScript()`、`getCountdownScript()`、`getRemoveCountdownAndShowLoadingScript()` 三个函数

### 优化
- 简化采集流程，打开网页后立即显示"采集中"弹窗并开始采集

---

## [2.2.1] - 2025-12-15

### 修复
- **修复 iframe 注入 bug**：当页面包含 iframe 时，弹窗和脚本可能被注入到 iframe 中而不是主页面。现在所有注入脚本都添加了 `if (window !== window.top) return;` 检查，确保只在用户指定的主页面中执行，不会影响 iframe

---

## [2.2.0] - 2025-12-15

### 新增
- **登录等待功能**：浏览器打开网页后，先弹窗询问用户"是否需要登录？"
  - 选择"是，我需要登录"：关闭弹窗，页面底部显示 10 秒倒计时，用户可在此期间完成登录操作
  - 选择"否，直接采集"：立即开始图片采集
- **底部倒计时条**：登录等待期间，页面底部显示醒目的倒计时进度条，提示剩余时间
- `overlay.ts` 新增 `getLoginPromptInitScript()`、`getCountdownScript()`、`getRemoveCountdownAndShowLoadingScript()` 三个函数

### 优化
- 支持需要登录才能查看完整内容的网站图片采集

---

## [2.1.1] - 2025-12-15

### 优化
- **文件名列宽度约束**：采集完成弹窗中表格的"文件名"列增加 max-width: 100px 限制，超长文件名单行溢出隐藏，鼠标悬停显示完整名称

---

## [2.1.0] - 2025-12-15

### 优化
- **图片文件名使用源文件名**：下载的图片不再使用数字命名（1.jpg, 2.jpg...），而是保留源图片的原始文件名
- **智能处理重名文件**：当遇到同名图片时，自动添加 (2), (3) 等后缀区分
- **无名图片兜底处理**：对于无法提取文件名的图片（如 URL 中没有有效文件名），使用 image_1, image_2 等默认名称

### 新增
- `utils.ts` 新增 `extractFileName()` 函数，用于从 URL 中提取原始文件名
- `collector.ts` 新增 `getUniqueFileName()` 函数，用于生成唯一文件名

---

## [2.0.3] - 2025-12-15

### 修复
- **修复 overlay.ts 版本号不同步**：overlay.ts 中的版本号从 2.0.0 更新为 2.0.3，与 package.json 保持一致

### 优化
- **完善版本管理规则**：更新 .claude/rules.md，明确列出 overlay.ts 中所有需要同步更新版本号的位置（共 4 处），并说明硬编码原因和快速更新方法

---

## [2.0.2] - 2025-12-15

### 文档
- **全面更新 CLAUDE.md**：
  - 更新项目结构，补充所有源文件和配置文件
  - 补充核心文件描述（5 个模块的职责说明）
  - 修正 MCP Tool 名称（pictureGrabber → collect_images）
  - 更新配置示例，使用通用路径占位符
  - 补充功能流程描述（弹窗、分类存放、自动打开文件夹等）
  - 新增弹窗功能说明
  - 完善注意事项（过滤小图、分类存放、命名规则）

---

## [2.0.1] - 2025-12-15

### 文档
- **修复桌面路径描述**：CLAUDE.md 中将硬编码的 `C:\Users\WIN7\Desktop` 改为动态描述 `{用户桌面}`，明确说明使用 `os.homedir()` 动态获取路径，兼容所有用户

---

## [2.0.0] - 2025-12-15

### 新增
- **弹窗显示版本号**：左上角服务标签新增版本号显示，格式为 `tp-image-collector MCP 提供服务 v2.0.0`
- **采集完成自动打开文件夹**：图片采集完成后，自动打开桌面上保存图片的文件夹，方便用户查看下载的图片

---

## [1.8.0] - 2025-12-15

### 新增
- **显示图片尺寸**：采集图片时获取每张图片的宽高尺寸，在明细列表中新增"图片尺寸"列，显示格式为 `宽x高`（如 `1920x1080`）

---

## [1.7.0] - 2025-12-15

### 优化
- **打钩图标位置调整**：采集完成的打钩图标移至"采集完成"文案后面，视觉更整洁
- **表格单元格最小宽度**：明细列表各列设置 min-width: 40px，避免内容挤压
- **图片地址可点击预览**：图片地址使用 a 标签包裹，点击可在新窗口预览原图

---

## [1.6.0] - 2025-12-15

### 新增
- **弹窗顶部服务标签**：在弹窗左上角增加 "tp-image-collector MCP 提供服务" 标签，统一品牌标识

---

## [1.5.0] - 2025-12-15

### 新增
- **采集结果按类型分 Tab 显示**：弹窗中新增 Tab 切换功能，可按图片类型（全部、JPG、PNG、WEBP、AVIF、GIF）筛选查看
- **文件夹按类型分类存放**：下载的图片按类型自动分到对应子目录（jpg/、png/、webp/、avif/、gif/）
- **列表显示图片类型列**：明细列表中新增"类型"列，便于识别图片格式

### 优化
- 弹窗布局调整，更好地展示分类信息

---

## [1.4.0] - 2025-12-15

### 新增
- **支持 gif 图片格式**：支持的格式扩展为 jpg/jpeg/png/webp/avif/gif
- **采集完成显示明细列表**：采集完成后在页面弹窗中显示每张图片的下载状态、文件名和来源地址

### 优化
- **不再自动关闭浏览器**：采集完成后浏览器保持打开状态，方便用户查看采集明细，需手动关闭

---

## [1.3.0] - 2025-12-15

### 新增
- **支持 webp 和 avif 图片格式**：现在可以采集 webp 和 avif 格式的图片，支持的格式扩展为 jpg/jpeg/png/webp/avif

---

## [1.2.0] - 2024-12-04

### 重构
- **代码模块化拆分**：将 434 行的单文件拆分为 5 个独立模块
  - `index.ts` (86行) - MCP 服务器入口，工具定义
  - `collector.ts` (156行) - 图片采集核心逻辑
  - `download.ts` (69行) - 图片下载功能
  - `overlay.ts` (186行) - 页面弹窗模板
  - `utils.ts` (46行) - 工具函数（路径、域名、时间戳等）

### 优化
- 提升代码可维护性，每个模块职责单一
- 消除弹窗 HTML/CSS 的重复代码
- 便于后续功能扩展和单元测试

---

## [1.1.0] - 2024-12-04

### 优化
- **弹窗显示时机优化**：使用 `page.addInitScript()` 预注入脚本，页面加载时立即显示"采集中"弹窗，而非等待页面完全加载后才显示
- 添加多重保障机制确保弹窗正确注入（DOMContentLoaded 事件 + 延时注入 + 后备注入）

### 新增
- 创建 CHANGELOG.md 版本更新记录文件
- 创建 .claude/rules.md 开发规范文件

---

## [1.0.0] - 2024-12-04

### 初始版本
- 实现 `collect_images` MCP 工具
- 支持采集网页上的 jpg/jpeg/png 格式图片
- 自动过滤 50x50 以下的小图
- 图片保存到桌面的 `图片采集_域名_时间戳` 目录
- 采集过程中显示 Loading 弹窗
- 采集完成后显示成功/失败结果
