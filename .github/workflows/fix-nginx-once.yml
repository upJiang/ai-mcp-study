name: Fix Nginx Configuration (Run Once)

on:
  workflow_dispatch:

jobs:
  fix-nginx:
    name: Fix Nginx and Check Logs
    runs-on: ubuntu-latest

    steps:
      - name: Fix Nginx Configuration
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 10m
          script: |
            set -e

            echo "========================================="
            echo "ğŸ”§ ä¿®å¤ MCP EventAnalyzer é…ç½®"
            echo "========================================="
            echo ""

            # æ­¥éª¤ 1: æŸ¥çœ‹å®¹å™¨è¯¦ç»†æ—¥å¿—
            echo "æ­¥éª¤ 1/5: æŸ¥çœ‹å®¹å™¨æ—¥å¿—..."
            cd /opt/mcp-services/ai-mcp-study/mcp-list
            docker-compose logs --tail=100 eventanalyzer
            echo ""

            # æ­¥éª¤ 2: æ£€æŸ¥å®¹å™¨å†…éƒ¨æœåŠ¡
            echo "æ­¥éª¤ 2/5: æµ‹è¯•å®¹å™¨å†…éƒ¨æœåŠ¡..."
            docker exec mcp-eventanalyzer curl -v http://localhost:8000/sse || echo "å®¹å™¨å†…éƒ¨æµ‹è¯•å¤±è´¥"
            echo ""

            # æ­¥éª¤ 3: å¤‡ä»½ Nginx é…ç½®
            echo "æ­¥éª¤ 3/5: å¤‡ä»½ç°æœ‰ Nginx é…ç½®..."
            sudo cp /www/server/nginx/conf/nginx.conf /www/server/nginx/conf/nginx.conf.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ“ å¤‡ä»½å®Œæˆ"
            echo ""

            # æ­¥éª¤ 4: æ·»åŠ  MCP è·¯ç”±åˆ° Nginx
            echo "æ­¥éª¤ 4/5: æ·»åŠ  MCP è·¯ç”±..."

            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ MCP é…ç½®
            if grep -q "location /mcp/eventanalyzer" /www/server/nginx/conf/nginx.conf; then
                echo "âš ï¸  MCP è·¯ç”±å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
            else
                # åˆ›å»ºä¸´æ—¶é…ç½®ç‰‡æ®µ
                cat > /tmp/mcp-location.conf << 'EOF'

    # MCP EventAnalyzer æœåŠ¡
    location /mcp/eventanalyzer {
        # é»˜è®¤è®¿é—®æ ¹è·¯å¾„æ—¶ï¼Œä»£ç†åˆ° /sse
        rewrite ^/mcp/eventanalyzer$ /sse break;
        rewrite ^/mcp/eventanalyzer(/.*)?$ $1 break;
        proxy_pass http://127.0.0.1:8100;

        # åŸºç¡€ä»£ç†å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE æ”¯æŒ
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding on;

        # é•¿è¿æ¥è¶…æ—¶
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # CORS æ”¯æŒ
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
EOF

                # æ‰¾åˆ°ä¸» server å—ï¼ˆserver_name junfeng530.xyzï¼‰å¹¶åœ¨å…¶ä¸­æ’å…¥é…ç½®
                # åœ¨æœ€åä¸€ä¸ª location å—ä¹‹åã€server å—ç»“æŸä¹‹å‰æ’å…¥
                sudo sed -i '/server_name junfeng530.xyz;/,/^[[:space:]]*}[[:space:]]*$/{
                    /^[[:space:]]*}[[:space:]]*$/ {
                        r /tmp/mcp-location.conf
                    }
                }' /www/server/nginx/conf/nginx.conf

                echo "âœ“ MCP è·¯ç”±å·²æ·»åŠ "
            fi
            echo ""

            # æ­¥éª¤ 5: æµ‹è¯•å¹¶é‡è½½ Nginx
            echo "æ­¥éª¤ 5/5: æµ‹è¯•å¹¶é‡è½½ Nginx..."
            if sudo nginx -t; then
                sudo systemctl reload nginx
                echo "âœ“ Nginx é‡è½½æˆåŠŸ"
            else
                echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
                echo "æ¢å¤å¤‡ä»½..."
                sudo cp /www/server/nginx/conf/nginx.conf.backup.* /www/server/nginx/conf/nginx.conf 2>/dev/null || true
                exit 1
            fi
            echo ""

            # éªŒè¯è®¿é—®
            echo "========================================="
            echo "âœ… é…ç½®å®Œæˆï¼Œæµ‹è¯•è®¿é—®..."
            echo "========================================="
            sleep 2
            curl -I https://junfeng530.xyz/mcp/eventanalyzer 2>&1 | head -10
            echo ""
            echo "========================================="
            echo "ğŸ‰ ä¿®å¤å®Œæˆï¼"
            echo "========================================="

      - name: Summary
        if: success()
        run: |
          echo "âœ… Nginx é…ç½®å·²ä¿®å¤"
          echo ""
          echo "ç°åœ¨å¯ä»¥åœ¨ Cursor ä¸­ä½¿ç”¨ï¼š"
          echo "URL: https://junfeng530.xyz/mcp/eventanalyzer"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ ä¿®å¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
