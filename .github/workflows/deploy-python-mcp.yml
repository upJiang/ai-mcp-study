name: Auto Deploy Python MCP Services

on:
  # ä»£ç åˆå¹¶åˆ° main åˆ†æ”¯åè§¦å‘
  push:
    branches:
      - main
    paths:
      - 'mcp-list/packages/**'
      - 'mcp-list/deployment/**'
      - '.github/workflows/deploy-python-mcp.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e

            echo "========================================="
            echo "å¼€å§‹è‡ªåŠ¨éƒ¨ç½² Python MCP æœåŠ¡"
            echo "========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/mcp-services/ai-mcp-study

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "æ­¥éª¤ 1/7: æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main
            echo "âœ“ ä»£ç æ›´æ–°å®Œæˆ"

            # è¿›å…¥ mcp-list ç›®å½•
            cd mcp-list

            # è‡ªåŠ¨ç”Ÿæˆ docker-compose.yml
            echo "æ­¥éª¤ 2/7: è‡ªåŠ¨ç”Ÿæˆ docker-compose.yml..."
            chmod +x deployment/generate-compose.sh
            ./deployment/generate-compose.sh
            echo "âœ“ docker-compose.yml ç”Ÿæˆå®Œæˆ"

            # è‡ªåŠ¨ç”Ÿæˆ Nginx é…ç½®
            echo "æ­¥éª¤ 3/7: è‡ªåŠ¨ç”Ÿæˆ Nginx é…ç½®..."
            chmod +x deployment/generate-nginx.sh
            ./deployment/generate-nginx.sh
            echo "âœ“ Nginx é…ç½®ç”Ÿæˆå®Œæˆ"

            # éƒ¨ç½² Nginx é…ç½®å¹¶é‡è½½
            echo "æ­¥éª¤ 4/7: æ›´æ–° Nginx é…ç½®..."
            sudo cp deployment/nginx/mcp-services.conf /etc/nginx/conf.d/
            sudo nginx -t
            sudo systemctl reload nginx
            echo "âœ“ Nginx é…ç½®å·²æ›´æ–°"

            # è·³è¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå„åŒ…è‡ªå·±ç®¡ç†ï¼‰
            echo "æ­¥éª¤ 5/7: è·³è¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå„åŒ…è‡ªè¡Œç®¡ç†ï¼‰..."
            echo "âœ“ å¦‚æœåŒ…éœ€è¦é…ç½®ï¼Œè¯·åœ¨åŒ…ç›®å½•ä¸‹åˆ›å»º .env æ–‡ä»¶"

            # åœæ­¢æ‰€æœ‰å®¹å™¨
            echo "æ­¥éª¤ 6/7: åœæ­¢æ—§å®¹å™¨..."
            docker-compose down || true
            echo "âœ“ å®¹å™¨å·²åœæ­¢"

            # é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆå¸¦å®¹é”™ï¼‰
            echo "æ­¥éª¤ 7/7: é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."

            # è·å–æ‰€æœ‰æœåŠ¡åç§°
            services=$(docker-compose config --services 2>/dev/null || echo "")

            if [ -z "$services" ]; then
                echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•æœåŠ¡"
                exit 0
            fi

            SUCCESS_COUNT=0
            FAILED_COUNT=0
            FAILED_SERVICES=""

            # é€ä¸ªæ„å»ºå’Œå¯åŠ¨æœåŠ¡ï¼ˆå®¹é”™ï¼‰
            for service in $services; do
              echo ""
              echo "ğŸ”¨ å¤„ç†æœåŠ¡: $service"

              # æ„å»ºæœåŠ¡
              if docker-compose build --no-cache "$service" 2>&1; then
                echo "âœ“ $service æ„å»ºæˆåŠŸ"

                # å¯åŠ¨æœåŠ¡
                if docker-compose up -d "$service" 2>&1; then
                  echo "âœ“ $service å¯åŠ¨æˆåŠŸ"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "âœ— $service å¯åŠ¨å¤±è´¥"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                  FAILED_SERVICES="$FAILED_SERVICES $service"
                fi
              else
                echo "âœ— $service æ„å»ºå¤±è´¥"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                FAILED_SERVICES="$FAILED_SERVICES $service"
              fi
            done

            echo ""
            echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡ï¼š"
            echo "  âœ“ æˆåŠŸ: $SUCCESS_COUNT"
            echo "  âœ— å¤±è´¥: $FAILED_COUNT"

            if [ $FAILED_COUNT -gt 0 ]; then
              echo "  âš ï¸  å¤±è´¥çš„æœåŠ¡:$FAILED_SERVICES"
              echo ""
              echo "âš ï¸  éƒ¨åˆ†æœåŠ¡éƒ¨ç½²å¤±è´¥ï¼Œä½†å…¶ä»–æœåŠ¡å·²æ­£å¸¸è¿è¡Œ"
            fi

            # éªŒè¯æœåŠ¡çŠ¶æ€
            echo ""
            echo "éªŒè¯æœåŠ¡çŠ¶æ€..."
            sleep 10
            docker-compose ps

            # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
            echo ""
            echo "æœåŠ¡å¥åº·æ£€æŸ¥ï¼š"

            # é€ä¸ªæ£€æŸ¥æœåŠ¡ï¼ˆä¸ä¸­æ–­ï¼‰
            for service in $services; do
              container="mcp-$service"

              # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
              if docker ps | grep -q "$container"; then
                # å¥åº·æ£€æŸ¥
                if docker exec "$container" curl -sf http://localhost:8000 > /dev/null 2>&1; then
                  echo "âœ“ $service - è¿è¡Œæ­£å¸¸"
                else
                  echo "âš ï¸  $service - å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½ä»åœ¨å¯åŠ¨ä¸­ï¼‰"
                fi
              else
                echo "âœ— $service - å®¹å™¨æœªè¿è¡Œ"
              fi
            done

            echo ""
            echo "========================================="
            if [ $FAILED_COUNT -eq 0 ]; then
              echo "âœ“ éƒ¨ç½²å®Œæˆï¼æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âš ï¸  éƒ¨ç½²å®Œæˆï¼Œä½†éƒ¨åˆ†æœåŠ¡å¤±è´¥"
            fi
            echo "========================================="

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Python MCP æœåŠ¡éƒ¨ç½²å®Œæˆ"
          echo ""
          echo "ğŸ“ è¯´æ˜ï¼šæœåŠ¡è®¿é—®åœ°å€æ ¹æ® packages ç›®å½•ä¸‹å®é™…å­˜åœ¨çš„ Python åŒ…åŠ¨æ€ç”Ÿæˆ"
          echo "   æ ¼å¼ï¼šhttps://junfeng530.xyz/mcp/{service-name}"
          echo ""
          echo "æŸ¥çœ‹æ—¥å¿—: ssh ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ 'cd /opt/mcp-services/ai-mcp-study/mcp-list && docker-compose logs -f'"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
