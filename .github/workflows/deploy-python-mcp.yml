name: Auto Deploy Python MCP Services

on:
  # ä»£ç åˆå¹¶åˆ° main åˆ†æ”¯åè§¦å‘ï¼ˆä»… Python åŒ…ï¼‰
  push:
    branches:
      - main
    paths:
      - 'mcp-list/packages/**/server.py'
      - 'mcp-list/packages/**/requirements.txt'
      - 'mcp-list/packages/**/src/**/*.py'
      - 'mcp-list/deployment/**'
      - '.github/workflows/deploy-python-mcp.yml'
      - 'fix-nginx-mcp.sh'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            set -e

            echo "========================================="
            echo "å¼€å§‹è‡ªåŠ¨éƒ¨ç½² Python MCP æœåŠ¡"
            echo "========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/mcp-services/ai-mcp-study

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "æ­¥éª¤ 1/7: æ‹‰å–æœ€æ–°ä»£ç ..."

            # ç¡®ä¿ GitHub åœ¨ known_hosts ä¸­ï¼ˆé¿å… Host key verification failedï¼‰
            if ! grep -q "github.com" ~/.ssh/known_hosts 2>/dev/null; then
              echo "æ·»åŠ  GitHub åˆ° known_hosts..."
              mkdir -p ~/.ssh
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null
              echo "âœ“ GitHub ä¸»æœºå¯†é’¥å·²æ·»åŠ "
            fi

            # æ£€æŸ¥å¹¶åˆ‡æ¢åˆ° SSH è¿œç¨‹ URLï¼ˆé¿å… HTTPS è¶…æ—¶é—®é¢˜ï¼‰
            # ä½¿ç”¨å…¼å®¹è€ç‰ˆæœ¬ Git çš„å‘½ä»¤
            CURRENT_URL=$(git config --get remote.origin.url)
            SSH_URL="git@github.com:upJiang/ai-mcp-study.git"

            if [[ "$CURRENT_URL" == https* ]]; then
              echo "æ£€æµ‹åˆ° HTTPS URLï¼Œåˆ‡æ¢åˆ° SSH..."
              git remote set-url origin "$SSH_URL"
              echo "âœ“ å·²åˆ‡æ¢åˆ° SSH: $SSH_URL"
            fi

            # å¼ºåˆ¶ä»è¿œç¨‹è·å–æœ€æ–°ä»£ç 
            echo "è·å–è¿œç¨‹æœ€æ–°ä»£ç ..."
            git fetch origin --force --prune --tags

            echo "éªŒè¯è¿œç¨‹åˆ†æ”¯çŠ¶æ€..."
            echo "  è¿œç¨‹ main: $(git log --oneline origin/main -1)"
            echo "  è§¦å‘æäº¤: $GITHUB_SHA"

            # éªŒè¯è¿œç¨‹åˆ†æ”¯æ˜¯å¦åŒ…å«è§¦å‘çš„æäº¤
            if ! git branch -r --contains "$GITHUB_SHA" | grep -q "origin/main"; then
              echo "âš ï¸  è­¦å‘Šï¼šè¿œç¨‹ main åˆ†æ”¯è¿˜ä¸åŒ…å«è§¦å‘æäº¤ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
              sleep 5
              git fetch origin --force --prune --tags
              echo "  é‡è¯•åè¿œç¨‹ main: $(git log --oneline origin/main -1)"
            fi

            echo "å¼ºåˆ¶æ¸…ç†æœ¬åœ°ä¿®æ”¹..."
            git checkout . 2>/dev/null || true
            git clean -fdx

            echo "é‡ç½®åˆ°è¿œç¨‹ main åˆ†æ”¯..."
            git reset --hard origin/main

            echo "éªŒè¯ä»£ç ç‰ˆæœ¬..."
            CURRENT_COMMIT=$(git log --oneline -1 --format="%H")
            EXPECTED_COMMIT=$(git log --oneline origin/main -1 --format="%H")

            if [ "$CURRENT_COMMIT" != "$EXPECTED_COMMIT" ]; then
              echo "âŒ é”™è¯¯ï¼šä»£ç ç‰ˆæœ¬ä¸åŒ¹é…ï¼"
              echo "  å½“å‰: $CURRENT_COMMIT"
              echo "  æœŸæœ›: $EXPECTED_COMMIT"
              exit 1
            fi

            echo "âœ“ å½“å‰ç‰ˆæœ¬: $(git log --oneline -1)"

            # æ¸…ç† packages ç›®å½•ä¸­ä¸åœ¨ Git çš„æ—§åŒ…
            echo "æ¸…ç†æ—§åŒ…..."
            cd mcp-list/packages
            git ls-files . | sed 's|/.*||' | sort -u > /tmp/git-packages.txt
            ls -d */ 2>/dev/null | sed 's|/||' | sort -u > /tmp/local-packages.txt
            comm -13 /tmp/git-packages.txt /tmp/local-packages.txt | while read dir; do
              if [ -d "$dir" ]; then
                echo "åˆ é™¤æ—§åŒ…: $dir"
                rm -rf "$dir"
              fi
            done
            cd ../..

            echo "âœ“ ä»£ç æ›´æ–°å®Œæˆ"

            # è¿›å…¥ mcp-list ç›®å½•
            cd mcp-list

            # è‡ªåŠ¨ç”Ÿæˆ docker-compose.yml
            echo "æ­¥éª¤ 2/7: è‡ªåŠ¨ç”Ÿæˆ docker-compose.yml..."
            chmod +x deployment/generate-compose.sh
            ./deployment/generate-compose.sh
            echo "âœ“ docker-compose.yml ç”Ÿæˆå®Œæˆ"

            # æ¸…ç†å¯èƒ½çš„å†²çªé…ç½®
            echo "æ­¥éª¤ 3/8: æ¸…ç†å¯èƒ½çš„å†²çª Nginx é…ç½®..."
            if [ -f /etc/nginx/conf.d/mcp-services.conf ]; then
              echo "åˆ é™¤æ—§çš„è‡ªåŠ¨ç”Ÿæˆé…ç½®ï¼ˆé¿å…ä¸ä¸»é…ç½®å†²çªï¼‰..."
              sudo rm -f /etc/nginx/conf.d/mcp-services.conf
              echo "âœ“ å·²åˆ é™¤ /etc/nginx/conf.d/mcp-services.conf"
            fi

            # è‡ªåŠ¨æ›´æ–° Nginx é…ç½®
            echo "æ­¥éª¤ 4/8: è‡ªåŠ¨æ›´æ–° Nginx é…ç½®..."
            cd /opt/mcp-services/ai-mcp-study

            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° nginx é…ç½®
            if [ -f fix-nginx-mcp.sh ]; then
              echo "è¿è¡Œ nginx é…ç½®æ›´æ–°è„šæœ¬..."
              chmod +x fix-nginx-mcp.sh
              bash fix-nginx-mcp.sh || echo "âš ï¸  Nginx é…ç½®æ›´æ–°å¤±è´¥ï¼Œä½†ç»§ç»­éƒ¨ç½²"
            else
              echo "âš ï¸  æœªæ‰¾åˆ° fix-nginx-mcp.shï¼Œè·³è¿‡ nginx é…ç½®æ›´æ–°"
            fi

            # éªŒè¯ Nginx é…ç½®
            echo "æ­¥éª¤ 5/8: éªŒè¯ Nginx é…ç½®..."
            sudo nginx -t
            echo "âœ“ Nginx é…ç½®éªŒè¯é€šè¿‡"

            # é‡è½½ Nginx
            echo "é‡è½½ Nginx æœåŠ¡..."
            sudo systemctl reload nginx
            echo "âœ“ Nginx å·²é‡è½½"

            # è·³è¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå„åŒ…è‡ªå·±ç®¡ç†ï¼‰
            echo "æ­¥éª¤ 6/8: è·³è¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå„åŒ…è‡ªè¡Œç®¡ç†ï¼‰..."
            echo "âœ“ å¦‚æœåŒ…éœ€è¦é…ç½®ï¼Œè¯·åœ¨åŒ…ç›®å½•ä¸‹åˆ›å»º .env æ–‡ä»¶"

            # åœæ­¢æ‰€æœ‰å®¹å™¨
            echo "æ­¥éª¤ 7/9: åœæ­¢æ—§å®¹å™¨..."
            cd mcp-list
            docker-compose down || true
            echo "âœ“ å®¹å™¨å·²åœæ­¢"

            # åˆ é™¤æ—§é•œåƒï¼Œå¼ºåˆ¶é‡å»º
            echo "æ­¥éª¤ 8/9: åˆ é™¤æ—§é•œåƒ..."
            docker images | grep "mcp-list-" | awk '{print $3}' | xargs -r docker rmi -f || true
            echo "âœ“ æ—§é•œåƒå·²æ¸…ç†"

            # é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆå¸¦å®¹é”™ï¼‰
            echo "æ­¥éª¤ 9/9: é‡å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡..."

            # è·å–æ‰€æœ‰æœåŠ¡åç§°
            services=$(docker-compose config --services 2>/dev/null || echo "")

            if [ -z "$services" ]; then
                echo "âš ï¸  è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•æœåŠ¡"
                exit 0
            fi

            SUCCESS_COUNT=0
            FAILED_COUNT=0
            FAILED_SERVICES=""

            # é€ä¸ªæ„å»ºå’Œå¯åŠ¨æœåŠ¡ï¼ˆå®¹é”™ï¼‰
            for service in $services; do
              echo ""
              echo "ğŸ”¨ å¤„ç†æœåŠ¡: $service"

              # æ„å»ºæœåŠ¡ï¼ˆä½¿ç”¨ç¼“å­˜ï¼Œä½†ä¼ å…¥æ—¶é—´æˆ³ç ´å COPY å±‚ç¼“å­˜ï¼‰
              if docker-compose build --build-arg CACHEBUST=$(date +%s) "$service" 2>&1; then
                echo "âœ“ $service æ„å»ºæˆåŠŸ"

                # å¯åŠ¨æœåŠ¡
                if docker-compose up -d "$service" 2>&1; then
                  echo "âœ“ $service å¯åŠ¨æˆåŠŸ"
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                else
                  echo "âœ— $service å¯åŠ¨å¤±è´¥"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                  FAILED_SERVICES="$FAILED_SERVICES $service"
                fi
              else
                echo "âœ— $service æ„å»ºå¤±è´¥"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                FAILED_SERVICES="$FAILED_SERVICES $service"
              fi
            done

            echo ""
            echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡ï¼š"
            echo "  âœ“ æˆåŠŸ: $SUCCESS_COUNT"
            echo "  âœ— å¤±è´¥: $FAILED_COUNT"

            if [ $FAILED_COUNT -gt 0 ]; then
              echo "  âš ï¸  å¤±è´¥çš„æœåŠ¡:$FAILED_SERVICES"
              echo ""
              echo "âš ï¸  éƒ¨åˆ†æœåŠ¡éƒ¨ç½²å¤±è´¥ï¼Œä½†å…¶ä»–æœåŠ¡å·²æ­£å¸¸è¿è¡Œ"
            fi

            # éªŒè¯æœåŠ¡çŠ¶æ€
            echo ""
            echo "éªŒè¯æœåŠ¡çŠ¶æ€..."
            sleep 10
            docker-compose ps

            # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
            echo ""
            echo "æœåŠ¡å¥åº·æ£€æŸ¥ï¼š"

            # é€ä¸ªæ£€æŸ¥æœåŠ¡ï¼ˆä¸ä¸­æ–­ï¼‰
            for service in $services; do
              container="mcp-$service"

              # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
              if docker ps | grep -q "$container"; then
                # å¥åº·æ£€æŸ¥
                if docker exec "$container" curl -sf http://localhost:8000 > /dev/null 2>&1; then
                  echo "âœ“ $service - è¿è¡Œæ­£å¸¸"
                else
                  echo "âš ï¸  $service - å¥åº·æ£€æŸ¥å¤±è´¥ï¼ˆå¯èƒ½ä»åœ¨å¯åŠ¨ä¸­ï¼‰"
                fi
              else
                echo "âœ— $service - å®¹å™¨æœªè¿è¡Œ"
              fi
            done

            echo ""
            echo "========================================="
            if [ $FAILED_COUNT -eq 0 ]; then
              echo "âœ“ éƒ¨ç½²å®Œæˆï¼æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âš ï¸  éƒ¨ç½²å®Œæˆï¼Œä½†éƒ¨åˆ†æœåŠ¡å¤±è´¥"
            fi
            echo "========================================="

      - name: Deployment summary
        if: success()
        run: |
          echo "âœ… Python MCP æœåŠ¡éƒ¨ç½²å®Œæˆ"
          echo ""
          echo "ğŸ“ è¯´æ˜ï¼šæœåŠ¡è®¿é—®åœ°å€æ ¹æ® packages ç›®å½•ä¸‹å®é™…å­˜åœ¨çš„ Python åŒ…åŠ¨æ€ç”Ÿæˆ"
          echo "   æ ¼å¼ï¼šhttps://junfeng530.xyz/mcp/{service-name}"
          echo ""
          echo "æŸ¥çœ‹æ—¥å¿—: ssh ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ 'cd /opt/mcp-services/ai-mcp-study/mcp-list && docker-compose logs -f'"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
