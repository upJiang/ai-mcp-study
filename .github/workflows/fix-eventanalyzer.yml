name: Fix EventAnalyzer MCP Service

on:
  # è‡ªåŠ¨è§¦å‘ï¼šæ¨é€åˆ° main åˆ†æ”¯ä¸”ä¿®æ”¹äº† EventAnalyzer ç›¸å…³æ–‡ä»¶
  push:
    branches:
      - main
    paths:
      - 'mcp-list/packages/EventAnalyzer/**'
      - 'mcp-list/docker-compose.yml'
      - 'fix-nginx-mcp.sh'
      - 'diagnose-eventanalyzer.sh'
      - '.github/workflows/fix-eventanalyzer.yml'

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œçš„æ“ä½œ'
        required: true
        default: 'diagnose-and-fix'
        type: choice
        options:
          - diagnose-only          # ä»…è¯Šæ–­
          - diagnose-and-fix       # è¯Šæ–­å¹¶è‡ªåŠ¨ä¿®å¤
          - force-restart          # å¼ºåˆ¶é‡å¯æœåŠ¡
          - rebuild-container      # é‡å»ºå®¹å™¨

jobs:
  fix-service:
    name: ä¿®å¤ EventAnalyzer æœåŠ¡
    runs-on: ubuntu-latest

    steps:
      - name: æ‰§è¡Œè¯Šæ–­å’Œä¿®å¤
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 20m
          script: |
            set -e

            # è‡ªåŠ¨è§¦å‘æ—¶é»˜è®¤é‡å»ºå®¹å™¨ï¼Œæ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨ç”¨æˆ·é€‰æ‹©
            ACTION="${{ github.event.inputs.action || 'rebuild-container' }}"

            echo "========================================="
            echo "ğŸ”§ EventAnalyzer æœåŠ¡ä¿®å¤å·¥å…·"
            echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            echo "æ‰§è¡Œæ“ä½œ: $ACTION"
            echo "========================================="
            echo ""

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/mcp-services/ai-mcp-study

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆåŒ…å«è¯Šæ–­è„šæœ¬ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin --force --prune
            git reset --hard origin/main
            echo "âœ“ ä»£ç å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
            echo ""

            # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
            chmod +x diagnose-eventanalyzer.sh

            # æ­¥éª¤ 1: è¿è¡Œè¯Šæ–­
            echo "========================================="
            echo "æ­¥éª¤ 1: è¿è¡Œè¯Šæ–­"
            echo "========================================="
            bash diagnose-eventanalyzer.sh
            echo ""

            # å¦‚æœåªæ˜¯è¯Šæ–­ï¼Œåˆ°æ­¤ç»“æŸ
            if [ "$ACTION" = "diagnose-only" ]; then
              echo "âœ… è¯Šæ–­å®Œæˆï¼ˆä»…è¯Šæ–­æ¨¡å¼ï¼‰"
              exit 0
            fi

            # æ­¥éª¤ 2: è‡ªåŠ¨ä¿®å¤
            echo "========================================="
            echo "æ­¥éª¤ 2: å¼€å§‹è‡ªåŠ¨ä¿®å¤"
            echo "========================================="
            echo ""

            cd /opt/mcp-services/ai-mcp-study/mcp-list

            # ä¿®å¤æ“ä½œ 1: ç¡®ä¿ Docker å®¹å™¨è¿è¡Œ
            echo "ğŸ”¨ ä¿®å¤ 1/4: æ£€æŸ¥å¹¶å¯åŠ¨ Docker å®¹å™¨..."
            if ! docker ps | grep -q "mcp-eventanalyzer"; then
              echo "å®¹å™¨æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."

              if [ "$ACTION" = "rebuild-container" ]; then
                echo "é‡å»ºå®¹å™¨é•œåƒ..."
                docker-compose build --build-arg CACHEBUST=$(date +%s) eventanalyzer
              fi

              docker-compose up -d eventanalyzer

              # ç­‰å¾…å®¹å™¨å¯åŠ¨
              echo "ç­‰å¾…å®¹å™¨å¯åŠ¨ï¼ˆ10 ç§’ï¼‰..."
              sleep 10

              if docker ps | grep -q "mcp-eventanalyzer"; then
                echo "âœ“ å®¹å™¨å¯åŠ¨æˆåŠŸ"
              else
                echo "âœ— å®¹å™¨å¯åŠ¨å¤±è´¥"
                echo "æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š"
                docker-compose logs --tail=50 eventanalyzer
                exit 1
              fi
            else
              if [ "$ACTION" = "force-restart" ] || [ "$ACTION" = "rebuild-container" ]; then
                echo "å¼ºåˆ¶é‡å¯å®¹å™¨..."
                docker-compose down eventanalyzer

                if [ "$ACTION" = "rebuild-container" ]; then
                  echo "é‡å»ºå®¹å™¨é•œåƒ..."
                  docker-compose build --build-arg CACHEBUST=$(date +%s) eventanalyzer
                fi

                docker-compose up -d eventanalyzer
                sleep 10
                echo "âœ“ å®¹å™¨å·²é‡å¯"
              else
                echo "âœ“ å®¹å™¨å·²åœ¨è¿è¡Œ"
              fi
            fi
            echo ""

            # ä¿®å¤æ“ä½œ 2: æ›´æ–° Nginx é…ç½®
            echo "ğŸ”¨ ä¿®å¤ 2/4: æ›´æ–° Nginx é…ç½®..."
            cd /opt/mcp-services/ai-mcp-study

            if [ -f fix-nginx-mcp.sh ]; then
              chmod +x fix-nginx-mcp.sh
              bash fix-nginx-mcp.sh || {
                echo "âš ï¸  è‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¿®å¤..."

                # æ‰‹åŠ¨æ£€æŸ¥å’Œä¿®å¤ nginx é…ç½®
                if ! grep -r "location /mcp/eventanalyzer" /www/server/nginx/ 2>/dev/null; then
                  echo "æœªæ‰¾åˆ° eventanalyzer é…ç½®ï¼Œè¿™å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨"
                  echo "è¯·æ£€æŸ¥ fix-nginx-mcp.sh è„šæœ¬çš„æ‰§è¡Œç»“æœ"
                fi
              }
            else
              echo "âš ï¸  æœªæ‰¾åˆ° fix-nginx-mcp.sh è„šæœ¬"
            fi
            echo ""

            # ä¿®å¤æ“ä½œ 3: éªŒè¯å¹¶é‡è½½ Nginx
            echo "ğŸ”¨ ä¿®å¤ 3/4: éªŒè¯å¹¶é‡è½½ Nginx..."
            if sudo nginx -t; then
              echo "âœ“ Nginx é…ç½®éªŒè¯é€šè¿‡"
              sudo systemctl reload nginx
              echo "âœ“ Nginx å·²é‡è½½"
            else
              echo "âœ— Nginx é…ç½®éªŒè¯å¤±è´¥"
              echo "è¯·æ£€æŸ¥ Nginx é…ç½®æ–‡ä»¶"
              sudo nginx -t 2>&1
              exit 1
            fi
            echo ""

            # ä¿®å¤æ“ä½œ 4: éªŒè¯æœåŠ¡çŠ¶æ€
            echo "ğŸ”¨ ä¿®å¤ 4/4: éªŒè¯æœåŠ¡çŠ¶æ€..."

            # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡ç¨³å®šï¼ˆ10 ç§’ï¼‰..."
            sleep 10

            # æµ‹è¯•å®¹å™¨ç›´æ¥è®¿é—®
            echo ""
            echo "æµ‹è¯• 1: å®¹å™¨ç›´æ¥è®¿é—® http://127.0.0.1:8100/sse"
            if curl -s -I http://127.0.0.1:8100/sse | head -1; then
              echo "âœ“ å®¹å™¨å¯è®¿é—®"
            else
              echo "âœ— å®¹å™¨ä¸å¯è®¿é—®"
            fi

            # æµ‹è¯• Nginx ä»£ç†
            echo ""
            echo "æµ‹è¯• 2: Nginx ä»£ç† https://junfeng530.xyz/mcp/eventanalyzer/sse"
            response=$(curl -s -I https://junfeng530.xyz/mcp/eventanalyzer/sse 2>&1)
            echo "$response" | head -5

            if echo "$response" | grep -q "200"; then
              echo "âœ“ Nginx ä»£ç†å·¥ä½œæ­£å¸¸"
            elif echo "$response" | grep -q "404"; then
              echo "âœ— ä»ç„¶è¿”å› 404 é”™è¯¯"
              echo ""
              echo "å¯èƒ½çš„åŸå› ï¼š"
              echo "1. Nginx é…ç½®æœªæ­£ç¡®åŒ…å« eventanalyzer location"
              echo "2. å®¹å™¨ç«¯å£æœªæ­£ç¡®æ˜ å°„"
              echo "3. éœ€è¦æ‰‹åŠ¨æ£€æŸ¥ Nginx é…ç½®æ–‡ä»¶"
            fi
            echo ""

            # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
            echo "========================================="
            echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€"
            echo "========================================="

            echo ""
            echo "Docker å®¹å™¨çŠ¶æ€:"
            docker ps | grep "mcp-eventanalyzer" || echo "å®¹å™¨æœªè¿è¡Œ"

            echo ""
            echo "ç«¯å£ç›‘å¬çŠ¶æ€:"
            ss -tlnp | grep ":8100" || echo "ç«¯å£ 8100 æœªç›‘å¬"

            echo ""
            echo "å®¹å™¨æœ€è¿‘æ—¥å¿— (20 è¡Œ):"
            docker logs --tail=20 mcp-eventanalyzer 2>&1

            echo ""
            echo "========================================="
            if echo "$response" | grep -q "200"; then
              echo "âœ… ä¿®å¤æˆåŠŸï¼æœåŠ¡å·²æ¢å¤æ­£å¸¸"
              echo ""
              echo "Cursor é…ç½®ï¼š"
              echo '  "EventAnalyzer": {'
              echo '    "url": "https://junfeng530.xyz/mcp/eventanalyzer/sse"'
              echo '  }'
              echo ""
              echo "è¯·å®Œå…¨é‡å¯ Cursor (Cmd+Q) ç„¶åé‡æ–°æ‰“å¼€"
            else
              echo "âš ï¸  è‡ªåŠ¨ä¿®å¤å¯èƒ½æœªå®Œå…¨æˆåŠŸ"
              echo ""
              echo "è¯·æ‰‹åŠ¨æ£€æŸ¥ï¼š"
              echo "1. æŸ¥çœ‹ä¸Šæ–¹çš„è¯Šæ–­ä¿¡æ¯"
              echo "2. æ£€æŸ¥å®¹å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯"
              echo "3. æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®"
              echo ""
              echo "å¦‚éœ€è¿›ä¸€æ­¥å¸®åŠ©ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æ—¥å¿—"
            fi
            echo "========================================="

      - name: ä¿®å¤å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… EventAnalyzer æœåŠ¡ä¿®å¤æµç¨‹å·²å®Œæˆ"
          echo ""
          echo "æ“ä½œ: ${{ github.event.inputs.action }}"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "1. æ£€æŸ¥ä¸Šæ–¹çš„æ‰§è¡Œæ—¥å¿—"
          echo "2. å¦‚æœæ˜¾ç¤ºä¿®å¤æˆåŠŸï¼Œåœ¨ Cursor ä¸­æµ‹è¯•è¿æ¥"
          echo "3. ç¡®ä¿ Cursor é…ç½®æ­£ç¡®:"
          echo '   "EventAnalyzer": {'
          echo '     "url": "https://junfeng530.xyz/mcp/eventanalyzer/sse"'
          echo '   }'
          echo "4. å®Œå…¨é‡å¯ Cursor (Cmd+Q)"

      - name: ä¿®å¤å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ EventAnalyzer æœåŠ¡ä¿®å¤å¤±è´¥"
          echo ""
          echo "è¯·æ£€æŸ¥ä¸Šæ–¹çš„é”™è¯¯æ—¥å¿—ï¼Œæˆ–æ‰‹åŠ¨ SSH åˆ°æœåŠ¡å™¨è¿›è¡Œè¯Šæ–­ï¼š"
          echo "ssh root@junfeng530.xyz"
          echo "cd /opt/mcp-services/ai-mcp-study"
          echo "bash diagnose-eventanalyzer.sh"
